const PC_PREFIX="https://alicdn.dingzh.cc/ding-BlogDemo/img/pcBg/pc_bg",PHONE_PREFIX="https://alicdn.dingzh.cc/ding-BlogDemo/img/phoneBg/phone_bg",PC_MAX=384,PHONE_MAX=200,BG_ID="web_bg",KEY_PC="bg.url.pc",KEY_MO="bg.url.mobile",OVERLAY_ID="bg-color-overlay",MODE_RANDOM="random",MODE_WHITE="white",MODE_BLACK="black",MODE_SEQUENCE=["white","black","random"],MODE_STORAGE_KEY="bg.manual.mode";function isValidMode(e){return"random"===e||"white"===e||"black"===e}function readStoredMode(){try{const e=localStorage.getItem("bg.manual.mode");return isValidMode(e)?e:"random"}catch(e){return"random"}}function getMode(){const e=window.__bg_override_mode__;return isValidMode(e)?e:"random"}function persistMode(e){const t=isValidMode(e)?e:"random";window.__bg_override_mode__=t;try{"random"===t?localStorage.removeItem("bg.manual.mode"):localStorage.setItem("bg.manual.mode",t)}catch(e){}return t}function dedupeModeButton(){const e=document.querySelectorAll("#cycle-bg-mode-btn");return e.length<=1?e[0]||null:(e.forEach(((e,t)=>t&&e.remove())),e[0])}function updateModeButton(e){const t=dedupeModeButton();if(!t)return;t.__baseTitle||(t.__baseTitle=t.getAttribute("data-title-base")||t.title||"");const n="white"===e?"data-white-label":"black"===e?"data-black-label":"data-random-label",o=n?t.getAttribute(n):"";t.title=o?`${t.__baseTitle} (${o})`:t.__baseTitle,t.setAttribute("data-mode",e)}function isMobile(){const e=navigator.userAgentData?.mobile;if(!0===e)return!0;const t=Math.min(window.innerWidth||0,screen.width||0),n=window.matchMedia?.("(pointer: coarse)")?.matches??!1;return t<=480||(!!(n&&t<=600)||/Android|iPhone|Windows Phone|Mobi/i.test(navigator.userAgent))}function pickRandomUrl(e){const t=Math.floor(Math.random()*(e?200:384))+1;return(e?PHONE_PREFIX:PC_PREFIX)+t+".jpg"}function getEl(){return document.getElementById(BG_ID)||document.body}function ensureOverlay(){let e=document.getElementById(OVERLAY_ID);return e?!e.isConnected&&document.body&&document.body.appendChild(e):(e=document.createElement("div"),e.id=OVERLAY_ID,Object.assign(e.style,{position:"fixed",inset:"0",zIndex:"-1",pointerEvents:"none",transition:"background 0.2s ease",display:"none"}),document.body?document.body.appendChild(e):document.addEventListener("DOMContentLoaded",(()=>{!e.isConnected&&document.body&&document.body.appendChild(e)}),{once:!0})),e}function showOverlay(e){const t=ensureOverlay();t.style.display="block",t.style.background=e}function hideOverlay(){const e=document.getElementById(OVERLAY_ID);e&&(e.style.display="none")}function getCurrentUrlCache(){return window.__bg_current_url||""}function setCurrentUrlCache(e){window.__bg_current_url=e||""}function seedCurrentUrlFromStorage(){if("random"===getMode()&&!getCurrentUrlCache())try{const e=isMobile()?KEY_MO:KEY_PC,t=sessionStorage.getItem(e);t&&setCurrentUrlCache(t)}catch(e){}}function syncModeToDom(e){const t=getMode();if("random"===t){if(hideOverlay(),e){const e=isMobile()?KEY_MO:KEY_PC,t=sessionStorage.getItem(e);t&&apply(t)}}else{showOverlay("white"===t?"#ffffff":"#000000")}if("random"!==t){if(!getCurrentUrlCache())try{const e=isMobile()?KEY_MO:KEY_PC,t=sessionStorage.getItem(e);t&&setCurrentUrlCache(t)}catch(e){}}updateModeButton(t)}function preload(e){return e?(window.__bg_preload_img__=window.__bg_preload_img__||new Image,new Promise((t=>{const n=window.__bg_preload_img__;if(n.src===e&&n.complete)return t();n.onload=n.onerror=()=>t(),n.src=e}))):Promise.resolve()}function apply(e){if("random"!==getMode()||!e)return;if(getCurrentUrlCache()===e)return;const t=getEl();t&&(t.style.backgroundImage=`url("${e}")`,setCurrentUrlCache(e))}function isHardReload(){const e=performance.getEntriesByType?.("navigation")?.[0];return!!e&&"reload"===e.type}function ensureElThen(e){if(getEl())return void e();let t=0;const n=setInterval((()=>{(getEl()||++t>40)&&(clearInterval(n),e())}),50)}if(isValidMode(window.__bg_override_mode__)||(window.__bg_override_mode__=readStoredMode()),updateModeButton(getMode()),seedCurrentUrlFromStorage(),window.__random_bg_inited__){const e=isMobile()?KEY_MO:KEY_PC,t=sessionStorage.getItem(e);ensureElThen((()=>{"random"===getMode()&&t?apply(t):t&&setCurrentUrlCache(t),syncModeToDom(!1)}))}else{window.__random_bg_inited__=!0,ensureElThen((async()=>{const e=isMobile(),t=e?KEY_MO:KEY_PC;let n=sessionStorage.getItem(t);if(!n||isHardReload()){n=pickRandomUrl(e),sessionStorage.setItem(t,n),await preload(n);const o=document.createElement("link");o.rel="preload",o.as="image",o.href=n,document.head&&document.head.appendChild(o)}"random"===getMode()?apply(n):setCurrentUrlCache(n||""),syncModeToDom(!1)}));const e=()=>{if("random"===getMode()){const e=isMobile()?KEY_MO:KEY_PC,t=sessionStorage.getItem(e);t&&apply(t)}else{const e=isMobile()?KEY_MO:KEY_PC,t=sessionStorage.getItem(e);t&&setCurrentUrlCache(t)}syncModeToDom(!1)};window.__bg_listeners_wired__||(window.__bg_listeners_wired__=!0,document.addEventListener("pjax:complete",e),document.addEventListener("pjax:success",e),document.addEventListener("pjax:end",e)),window.addEventListener("pageshow",(t=>{t.persisted&&e()}))}window.changeBackground=async function(){const e=isMobile(),t=e?KEY_MO:KEY_PC,n=pickRandomUrl(e);sessionStorage.setItem(t,n),await preload(n),apply(n),"random"!==getMode()&&setCurrentUrlCache(n)},window.cycleBackgroundMode=function(e){const t=getMode(),n=MODE_SEQUENCE.indexOf(t);persistMode(MODE_SEQUENCE[(n+1)%MODE_SEQUENCE.length]),syncModeToDom(!0),e&&"function"==typeof e.blur&&e.blur()};